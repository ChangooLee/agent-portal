# Agent Portal — AI Coding Guidelines

> **Purpose**: Rules for Cursor AI to work effectively on the Agent Portal project  
> **Philosophy**: Planning-First Development — think deeply before writing code

---

## Core Principles

### 0. Sensitive Information Protection (CRITICAL)

**Definition**: API keys, passwords, tokens, database credentials, PII

**Prohibited**:
- Creating `.env` backup files (`.env.bak`, `.env.backup`)
- Adding sensitive files to git
- Exposing API keys in logs/output
- Hardcoding credentials in code

**Required Confirmation** (ask user in Korean):
```
⚠️ "이 작업은 민감 정보(.env, API 키 등)를 포함합니다. 진행할까요?"
```

**Safe Alternatives**:
- Use `.env.example` with placeholders
- Reference env vars: `os.environ.get('API_KEY')`
- Verify `.gitignore` includes sensitive files

### 0.1 Test Before Completion (CRITICAL)

**Completion Criteria**:
- Code alone is NOT complete
- Must run actual tests before marking TODO complete

**Test Procedure**:
1. Backend API: `curl http://localhost:8000/api/...`
2. Frontend: Browser check, console errors
3. Integration: End-to-end flow

**Correct Flow**:
```
1. Write/modify code
2. Restart service if needed
3. Run actual test (curl/browser)
4. Check results
5. ✅ No errors → TODO completed
6. ❌ Error → fix and retry from step 2
```

### 1. Planning-First Approach (ALWAYS)

**Before coding (15-20 min)**:
- Research best practices (web search)
- Check codebase for existing patterns
- Compare 2-3 approaches with tradeoffs

**After completion (5-10 min)**:
- Record learnings in `.cursor/learnings/`
- Update documentation if significant

### 2. Required References

**Priority 1: Specialized Rules (.cursor/rules/*.mdc)**
- `backend-api.mdc` — FastAPI, services, error handling
- `ui-development.mdc` — SvelteKit, Tailwind, patterns
- `admin-screens.mdc` — Admin UI, Glassmorphism
- `monitoring-development.mdc` — ClickHouse, OTEL traces
- `datacloud-development.mdc` — Database connector, Text-to-SQL
- `mcp-gateway.mdc` — MCP servers, Kong integration

**Priority 2: Project Documents**
- `CLAUDE.md` — Quick reference
- `AGENTS.md` — Project structure, workflows

**Priority 3: Skills (On-Demand Only)**
- `webui/.skills/ui-summary.json` — Quick route/pattern lookup
- For detailed queries, use jq on full Skills files

---

## File Discovery

### UI Components
```
webui/src/routes/(app)/           # Page routes
webui/src/routes/(app)/admin/     # Admin pages
webui/src/lib/components/         # Reusable components
webui/src/lib/monitoring/         # Monitoring API client
```

### Backend
```
backend/app/routes/               # API endpoints
backend/app/services/             # Business logic
backend/app/middleware/           # RBAC, auth
backend/app/config.py             # Settings
```

### Quick Reference (ui-summary.json)
```json
{
  "routes": {
    "admin/monitoring": "routes/(app)/admin/monitoring/+page.svelte",
    "admin/datacloud": "routes/(app)/admin/datacloud/+page.svelte"
  }
}
```

### On-Demand Queries
```bash
# Find route by keyword
jq '.routes[] | select(.routePath | contains("monitoring"))' webui/.skills/ui-structure.json

# Find pattern by type
jq '.buttonPatterns[] | select(.type == "tab")' webui/.skills/ui-patterns.json
```

---

## Task Checklists

### UI Development

**Before**:
- [ ] Check ui-summary.json for route paths
- [ ] Review existing patterns in target file

**During**:
- [ ] Use Glassmorphism patterns for admin pages
- [ ] Support dark/light mode
- [ ] Test responsive design

**After**:
- [ ] Browser test in multiple viewports
- [ ] Check console for errors

### Backend API Development

**Before**:
- [ ] Check existing service patterns in `backend/app/services/`
- [ ] Review similar endpoints

**During**:
- [ ] Use async methods (`async def`)
- [ ] Add type hints
- [ ] Set timeout for external calls (default 30s)
- [ ] Handle errors with HTTPException

**After**:
- [ ] Test with curl
- [ ] Check OpenAPI docs at `/docs`

---

## Guardrails

### Prohibited

1. **Ignoring existing patterns**
   - ❌ New style for similar component
   - ✅ Reuse existing patterns

2. **Skipping tests**
   - ❌ "Implementation complete" without testing
   - ✅ Actually run and verify

3. **Missing error handling**
   - ❌ External call without try/except
   - ✅ Handle timeout, HTTP errors

4. **Direct API calls from frontend**
   - ❌ `fetch('http://localhost:8000/...')`
   - ✅ `fetch('/api/...')` (use Vite proxy)

### Always Provide Alternatives

When something fails, offer 2-3 solutions:
```
**Problem**: Router not registered
**Solutions**:
1. Check import in main.py
2. Verify app.include_router() call
3. Rebuild container: docker-compose build --no-cache backend
```

---

## Key Patterns

### Backend Service (Singleton)
```python
class ExampleService:
    def __init__(self):
        self.base_url = "http://service:8080"
    
    async def get_data(self, id: str) -> Dict[str, Any]:
        async with httpx.AsyncClient(timeout=30.0) as client:
            response = await client.get(f"{self.base_url}/data/{id}")
            response.raise_for_status()
            return response.json()

# Singleton instance
example_service = ExampleService()
```

### Error Handling
```python
try:
    async with httpx.AsyncClient(timeout=30.0) as client:
        response = await client.get(url)
        response.raise_for_status()
        return response.json()
except httpx.TimeoutException:
    raise HTTPException(status_code=504, detail="External API timeout")
except httpx.HTTPStatusError as e:
    raise HTTPException(status_code=e.response.status_code, detail=str(e))
```

### Glassmorphism Card
```svelte
<div class="bg-white/60 dark:bg-gray-800/60 backdrop-blur-sm rounded-2xl border border-white/20 dark:border-gray-700/20 shadow-sm p-6">
  <!-- Content -->
</div>
```

### Modal
```svelte
{#if showModal}
<div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center">
  <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
    <!-- Header -->
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
      <h2 class="text-lg font-semibold">Title</h2>
    </div>
    <!-- Content -->
    <div class="p-6">...</div>
  </div>
</div>
{/if}
```

---

## Services & Ports

| Service | Port | Purpose |
|---------|------|---------|
| Backend BFF | 8000 | FastAPI gateway |
| Open-WebUI | 3001 | Portal UI |
| LiteLLM | 4000 | LLM proxy |
| ClickHouse | 8124 | Monitoring traces |
| MariaDB | 3306 | App database |
| Kong | 8002 | API Gateway |

---

## Learning System

### Record Learnings
After significant work, update `.cursor/learnings/`:
- `api-patterns.md` — Backend patterns
- `ui-patterns.md` — Frontend patterns
- `bug-fixes.md` — Issues and solutions
- `preferences.md` — User preferences

### Format
```markdown
## YYYY-MM-DD: Title

**Request**: What was asked
**Applied**: What was done
**Feedback**: ✅ Approved / ❌ Rejected
**Reuse**: How to apply in future
```

---

## User Communication

Always communicate with the user in Korean:
```
✅ "구현 완료했습니다. 브라우저에서 확인해주세요."
✅ "이 작업을 진행하기 전에 확인이 필요합니다."
❌ "Implementation complete. Please check in browser."
```

---

**Last Updated**: 2025-11-28  
**Version**: 3.0 (English, optimized context)
