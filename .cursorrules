# Agent Portal — AI Coding Guidelines (Comprehensive)

> **목적**: Cursor AI가 Agent Portal 프로젝트에서 효과적으로 작업하기 위한 완전한 가이드
> **철학**: 계획 우선 개발 — 코드 작성 전 깊이 생각하기
> **버전**: 4.0 (2025-11-28)

---

## 목차

1. [핵심 원칙](#핵심-원칙)
2. [개발 환경 관리](#개발-환경-관리)
3. [서비스 참조](#서비스-참조)
4. [작업 체크리스트](#작업-체크리스트)
5. [트러블슈팅](#트러블슈팅)
6. [코드 패턴](#코드-패턴)
7. [학습 시스템](#학습-시스템)

---

## 핵심 원칙

### 0. 민감 정보 보호 (CRITICAL)

**정의**: API 키, 비밀번호, 토큰, 데이터베이스 자격 증명, PII

**금지 사항**:
- `.env` 백업 파일 생성 (`.env.bak`, `.env.backup`)
- git에 민감 파일 추가
- 로그/출력에 API 키 노출
- 코드에 자격 증명 하드코딩

**필수 확인** (한국어로 질문):
```
⚠️ "이 작업은 민감 정보(.env, API 키 등)를 포함합니다. 진행할까요?"
```

**안전한 대안**:
- `.env.example`에 플레이스홀더 사용
- 환경 변수 참조: `os.environ.get('API_KEY')`
- `.gitignore`에 민감 파일 포함 확인

### 0.1 완료 전 테스트 (CRITICAL)

**완료 기준**:
- 코드만으로는 완료가 아님
- TODO 완료 표시 전 실제 테스트 필수

**테스트 절차**:
1. Backend API: `curl http://localhost:8000/api/...`
2. Frontend: 브라우저 확인, 콘솔 에러
3. 통합: 전체 흐름 테스트

**올바른 흐름**:
```
1. 코드 작성/수정
2. 필요시 서비스 재시작
3. 실제 테스트 실행 (curl/브라우저)
4. 결과 확인
5. ✅ 에러 없음 → TODO 완료
6. ❌ 에러 있음 → 수정 후 2단계부터 재시도
```

### 1. 계획 우선 접근법 (ALWAYS)

**코딩 전 (15-20분)**:
- 모범 사례 리서치 (웹 검색)
- 기존 패턴 확인
- 2-3가지 접근법 비교

**완료 후 (5-10분)**:
- `.cursor/learnings/`에 학습 내용 기록
- 중요한 경우 문서 업데이트

### 2. 필수 참조 문서

**우선순위 1: 전문 규칙 (.cursor/rules/*.mdc)**
- `backend-api.mdc` — FastAPI, 서비스, 에러 처리
- `ui-development.mdc` — SvelteKit, Tailwind, 패턴
- `admin-screens.mdc` — Admin UI, Glassmorphism
- `monitoring-development.mdc` — ClickHouse, OTEL 트레이스
- `datacloud-development.mdc` — Database connector, Text-to-SQL
- `mcp-gateway.mdc` — MCP 서버, Kong 연동

**우선순위 2: 프로젝트 문서**
- `CLAUDE.md` — 빠른 참조
- `AGENTS.md` — 프로젝트 구조, 워크플로우

**우선순위 3: Skills (온디맨드)**
- `webui/.skills/ui-summary.json` — 빠른 라우트/패턴 조회
- 상세 조회 시 jq로 Skills 파일 쿼리

---

## 개발 환경 관리

### 상태 추적 시스템

**상태 파일 위치**: `.cursor/state/services.json`

**재기동/빌드 전 필수 확인**:
```bash
# 항상 먼저 health check 실행
./scripts/health-check.sh

# 상태 파일 확인
cat .cursor/state/services.json | jq '.services'

# 마지막 성공 빌드 확인
cat .cursor/state/services.json | jq '.last_successful_build'
```

### Docker Compose 환경

**개발 모드** (기본):
```bash
# 기본 compose 사용
docker compose up -d

# 개발 override 사용 (선택)
docker compose -f docker-compose.yml -f docker-compose.dev.yml up -d
```

**운영 모드**:
```bash
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
```

### 서비스 재시작 절차

**단일 서비스 재시작**:
```bash
# 1. 현재 상태 저장
./scripts/pre-build.sh backend

# 2. 재시작
docker compose restart backend

# 3. 상태 확인
./scripts/health-check.sh
```

**서비스 재빌드**:
```bash
# 1. 사전 빌드 체크 (롤백 포인트 생성)
./scripts/pre-build.sh backend

# 2. 빌드 (--no-cache로 완전 재빌드)
docker compose build --no-cache backend

# 3. 시작
docker compose up -d backend

# 4. 상태 확인
./scripts/health-check.sh

# 5. 성공 시 상태 파일 업데이트
# (health-check.sh가 자동 업데이트)
```

### 롤백 절차

빌드 실패 시:
```bash
# 롤백 포인트 확인
ls .cursor/state/rollback/

# 이전 상태로 복원
./scripts/rollback.sh <rollback_id>
```

---

## 서비스 참조

### 핵심 서비스

| 서비스 | 포트 | 역할 | Health 엔드포인트 |
|--------|------|------|-------------------|
| backend | 8000 | FastAPI BFF | http://localhost:8000/docs |
| webui | 3001 | Portal UI | http://localhost:3001 |
| litellm | 4000 | LLM 프록시 | http://localhost:4000/health |
| clickhouse | 8124 | 모니터링 트레이스 | http://localhost:8124/ping |
| mariadb | 3306 | 앱 데이터베이스 | - |
| kong | 8002 | API Gateway | http://localhost:8002/status |

### 보조 서비스

| 서비스 | 포트 | 역할 |
|--------|------|------|
| redis | 6379 | 캐시 |
| langfuse | 3003 | LLM 관찰성 |
| prometheus | 9090 | 메트릭 |
| minio | 9000/9001 | 오브젝트 스토리지 |
| chromadb | 8001 | 벡터 DB |
| otel-collector | 4317/4318 | 트레이스 수집 |

### 서비스별 로그 확인

```bash
# Backend 로그
docker compose logs backend --tail=50 -f

# WebUI 로그
docker compose logs webui --tail=50 -f

# LiteLLM 로그
docker compose logs litellm --tail=50 -f

# 전체 서비스 로그
docker compose logs --tail=20 -f
```

### 서비스별 트러블슈팅

#### Backend (8000)

**문제: 컨테이너 시작 안됨**
```bash
# 로그 확인
docker compose logs backend --tail=100

# 일반적 원인:
# 1. Python 의존성 에러 → requirements.txt 확인
# 2. 환경 변수 누락 → .env 확인
# 3. 포트 충돌 → lsof -i :8000
```

**문제: API 응답 없음**
```bash
# 컨테이너 상태 확인
docker compose ps backend

# FastAPI 문서 확인
curl http://localhost:8000/docs

# 라우터 등록 확인
docker compose exec backend cat /app/app/main.py | grep include_router
```

#### WebUI (3001)

**문제: 빈 페이지**
```bash
# 빌드 에러 확인
docker compose logs webui --tail=100 | grep -i error

# Vite 서버 상태
curl http://localhost:3001

# 환경 변수 확인
docker compose exec webui printenv | grep -i vite
```

#### ClickHouse (8124)

**문제: 쿼리 실패**
```bash
# 연결 확인
curl http://localhost:8124/ping

# 데이터베이스 목록
docker compose exec monitoring-clickhouse clickhouse-client \
  --query "SHOW DATABASES"

# 테이블 구조 확인
docker compose exec monitoring-clickhouse clickhouse-client \
  --query "DESCRIBE otel_2.otel_traces"
```

---

## 작업 체크리스트

### UI 개발

**시작 전**:
- [ ] `ui-summary.json`에서 라우트 경로 확인
- [ ] 대상 파일의 기존 패턴 검토
- [ ] 다크/라이트 모드 지원 확인

**개발 중**:
- [ ] Admin 페이지는 Glassmorphism 패턴 사용
- [ ] 다크/라이트 모드 지원
- [ ] 반응형 디자인 테스트
- [ ] API 호출은 `/api/*` 프록시 사용

**완료 후**:
- [ ] 여러 뷰포트에서 브라우저 테스트
- [ ] 콘솔 에러 확인
- [ ] 다크/라이트 모드 토글 테스트

### Backend API 개발

**시작 전**:
- [ ] `backend/app/services/`에서 기존 서비스 패턴 확인
- [ ] 유사 엔드포인트 검토
- [ ] 에러 처리 계획

**개발 중**:
- [ ] `async def` 사용
- [ ] 타입 힌트 추가
- [ ] 외부 호출에 timeout 설정 (기본 30s)
- [ ] HTTPException으로 에러 처리

**완료 후**:
- [ ] curl로 테스트
- [ ] `/docs`에서 OpenAPI 문서 확인
- [ ] 에러 케이스 테스트

### 서비스 재시작

**시작 전**:
- [ ] `./scripts/health-check.sh` 실행
- [ ] 현재 상태 확인

**실행**:
- [ ] `./scripts/pre-build.sh <service>` 실행
- [ ] 빌드/재시작 명령 실행
- [ ] `./scripts/health-check.sh`로 확인

**완료 후**:
- [ ] 서비스 정상 작동 확인
- [ ] 로그에 에러 없음 확인

### 데이터베이스 변경

**시작 전**:
- [ ] 현재 스키마 확인 (DESCRIBE)
- [ ] 백업 필요 여부 확인

**MariaDB 변경**:
```bash
# 스키마 확인
docker compose exec mariadb mariadb -uroot -prootpass agent_portal \
  -e "DESCRIBE table_name;"

# 스키마 변경
docker compose exec mariadb mariadb -uroot -prootpass agent_portal \
  -e "ALTER TABLE table_name ADD column_name VARCHAR(255);"
```

**ClickHouse 변경**:
```bash
# 스키마 확인
docker compose exec monitoring-clickhouse clickhouse-client \
  --query "DESCRIBE otel_2.table_name"
```

---

## 트러블슈팅

### 포트 충돌

```bash
# 포트 사용 확인
lsof -i :8000
lsof -i :3001

# 프로세스 종료
kill -9 <PID>

# 또는 다른 포트 사용
docker compose down
# docker-compose.yml에서 포트 변경 후
docker compose up -d
```

### 컨테이너 시작 실패

```bash
# 상태 확인
docker compose ps

# 로그 확인
docker compose logs <service> --tail=100

# 강제 재생성
docker compose up -d --force-recreate <service>

# 완전 재빌드
docker compose build --no-cache <service>
docker compose up -d <service>
```

### 데이터베이스 연결 에러

**MariaDB**:
```bash
# 컨테이너 상태
docker compose ps mariadb

# 연결 테스트
docker compose exec mariadb mariadb -uroot -prootpass -e "SELECT 1;"

# 로그 확인
docker compose logs mariadb --tail=50
```

**ClickHouse**:
```bash
# 연결 테스트
curl http://localhost:8124/ping

# 쿼리 테스트
curl "http://localhost:8124/?query=SELECT%201"

# 로그 확인
docker compose logs monitoring-clickhouse --tail=50
```

### CORS 에러

Frontend에서 CORS 에러 발생 시:

```javascript
// ❌ 잘못된 방법: 직접 호출
fetch('http://localhost:8000/api/...')

// ✅ 올바른 방법: Vite 프록시 사용
fetch('/api/...')
```

Vite 프록시 설정 확인:
```typescript
// webui/vite.config.ts
'/api/datacloud': {
    target: 'http://localhost:8000',
    changeOrigin: true,
    rewrite: (path) => path.replace(/^\/api\/datacloud/, '/datacloud')
}
```

### 라우터 미등록

```python
# backend/app/main.py 확인
# 라우터가 등록되어 있는지 확인
app.include_router(example_router, prefix="/example")

# 컨테이너 내부 파일 확인
docker compose exec backend cat /app/app/main.py | grep include_router

# 재빌드 필요 시
docker compose build --no-cache backend
docker compose up -d backend
```

### ClickHouse 쿼리 에러

**project_id 찾을 수 없음**:
```sql
-- ❌ 잘못됨: project_id는 직접 컬럼이 아님
WHERE project_id = '...'

-- ✅ 올바름: ResourceAttributes 맵에서 접근
WHERE ResourceAttributes['project_id'] = '...'
```

**Duration 단위**:
```sql
-- ClickHouse는 나노초로 저장
-- 밀리초로 변환: Duration / 1000000
SELECT Duration / 1000000 as duration_ms FROM otel_traces
```

---

## 코드 패턴

### Backend 서비스 (Singleton)

```python
# backend/app/services/example_service.py
from typing import Dict, Any
import httpx
from fastapi import HTTPException

class ExampleService:
    def __init__(self):
        self.base_url = "http://service:8080"
    
    async def get_data(self, id: str) -> Dict[str, Any]:
        try:
            async with httpx.AsyncClient(timeout=30.0) as client:
                response = await client.get(f"{self.base_url}/data/{id}")
                response.raise_for_status()
                return response.json()
        except httpx.TimeoutException:
            raise HTTPException(status_code=504, detail="External API timeout")
        except httpx.HTTPStatusError as e:
            raise HTTPException(status_code=e.response.status_code, detail=str(e))

# Singleton 인스턴스
example_service = ExampleService()
```

### 에러 처리

```python
try:
    async with httpx.AsyncClient(timeout=30.0) as client:
        response = await client.get(url)
        response.raise_for_status()
        return response.json()
except httpx.TimeoutException:
    raise HTTPException(status_code=504, detail="외부 API 타임아웃")
except httpx.HTTPStatusError as e:
    raise HTTPException(status_code=e.response.status_code, detail=str(e))
except Exception as e:
    raise HTTPException(status_code=500, detail=f"예상치 못한 오류: {str(e)}")
```

### Glassmorphism 카드

```svelte
<div class="bg-white/60 dark:bg-gray-800/60 backdrop-blur-sm rounded-2xl 
            border border-white/20 dark:border-gray-700/20 shadow-sm p-6">
  <!-- Content -->
</div>
```

### 모달

```svelte
{#if showModal}
<div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 
            flex items-center justify-center p-4">
  <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl 
              max-w-2xl w-full max-h-[90vh] overflow-hidden">
    <!-- Header -->
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 
                flex items-center justify-between">
      <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Title</h2>
      <button on:click={() => showModal = false} 
              class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
        <XMark class="w-5 h-5" />
      </button>
    </div>
    
    <!-- Content -->
    <div class="p-6">...</div>
    
    <!-- Footer -->
    <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 
                flex justify-end gap-3">
      <button class="px-4 py-2 rounded-lg bg-gray-100 dark:bg-gray-700">
        취소
      </button>
      <button class="px-4 py-2 rounded-lg bg-primary text-white">
        저장
      </button>
    </div>
  </div>
</div>
{/if}
```

### API 호출 (Frontend)

```typescript
// ✅ Vite 프록시 사용
const response = await fetch('/api/datacloud/connections');

// API 에러 처리
if (!response.ok) {
    const error = await response.json();
    throw new Error(error.detail || 'API 호출 실패');
}

const data = await response.json();
```

---

## 학습 시스템

### 학습 기록

중요한 작업 후 `.cursor/learnings/`에 기록:
- `api-patterns.md` — Backend 패턴
- `ui-patterns.md` — Frontend 패턴
- `bug-fixes.md` — 이슈와 해결책
- `preferences.md` — 사용자 선호도

### 기록 형식

```markdown
## YYYY-MM-DD: 제목

**요청**: 요청 내용
**적용**: 적용한 내용
**피드백**: ✅ 승인 / ❌ 거부
**재사용**: 향후 적용 방법
```

---

## 금지 사항

1. **기존 패턴 무시**
   - ❌ 유사 컴포넌트에 새 스타일 적용
   - ✅ 기존 패턴 재사용

2. **테스트 생략**
   - ❌ 테스트 없이 "구현 완료"
   - ✅ 실제 실행 및 검증

3. **에러 처리 누락**
   - ❌ try/except 없이 외부 호출
   - ✅ 타임아웃, HTTP 에러 처리

4. **Frontend 직접 API 호출**
   - ❌ `fetch('http://localhost:8000/...')`
   - ✅ `fetch('/api/...')` (Vite 프록시 사용)

5. **재시작 전 상태 확인 생략**
   - ❌ 바로 재시작/빌드
   - ✅ `./scripts/health-check.sh` 먼저 실행

---

## 사용자 커뮤니케이션

항상 한국어로 소통:
```
✅ "구현 완료했습니다. 브라우저에서 확인해주세요."
✅ "이 작업을 진행하기 전에 확인이 필요합니다."
✅ "health check 결과 모든 서비스가 정상입니다."
❌ "Implementation complete. Please check in browser."
```

---

**마지막 업데이트**: 2025-11-28  
**버전**: 4.0 (Comprehensive, Korean)
