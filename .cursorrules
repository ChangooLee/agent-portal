# Agent Portal — AI Behavioral Guidelines

> **Purpose**: Define HOW the AI should behave, think, and communicate
> **Philosophy**: Plan before code, test before complete, ask before breaking
> **Version**: 5.0 (2025-11-28)

---

## 1. Core Principles (CRITICAL)

### 1.1 Security & Sensitive Data

**NEVER**:
- Create `.env` backup files (`.env.bak`, `.env.backup`)
- Add sensitive files to git
- Expose API keys in logs or output
- Hardcode credentials in code

**ALWAYS**:
- Use `.env.example` with placeholders
- Reference via `os.environ.get('API_KEY')`
- Verify `.gitignore` includes sensitive files
- Ask user before any operation involving sensitive data:
  ```
  ⚠️ "This operation involves sensitive data (.env, API keys). Proceed?"
  ```

### 1.2 Test Before Complete

**Completion Criteria**:
- Code alone is NOT complete
- MUST test before marking TODO as done

**Testing Flow**:
```
1. Write/modify code
2. Restart service if needed
3. Execute actual test (curl/browser)
4. Verify result
5. ✅ No errors → Mark complete
6. ❌ Errors found → Fix and retry from step 2
```

**Test Methods by Area**:
- Backend API: `curl http://localhost:8000/...`
- Frontend: Browser check + console errors
- Integration: Full flow test

### 1.3 Plan Before Code

**Before Coding (15-20 min)**:
- Research best practices (web search)
- Review existing patterns in codebase
- Compare 2-3 approaches

**After Completion (5-10 min)**:
- Record learnings in `.cursor/learnings/`
- Update documentation if significant

### 1.4 Ask Before Major Changes

**MUST ask user before**:
- Modifying working code
- Changing database schema
- Deleting files
- Restructuring project layout
- Any operation that cannot be easily undone

---

## 2. Decision Framework

### 2.1 When to Ask vs Proceed

**Ask User**:
- Task is ambiguous or has multiple valid interpretations
- Change affects existing working functionality
- Operation involves sensitive data
- Significant architectural decision
- Breaking change to public API

**Proceed Autonomously**:
- Task is clearly defined
- Following established patterns
- Adding new isolated feature
- Fixing obvious bugs
- Routine refactoring within single file

### 2.2 When to Use Existing Code vs Create New

**Use Existing**:
- Similar functionality exists anywhere in codebase
- Established pattern covers use case
- Utility function already handles requirement

**Create New (Only When)**:
- No existing solution fits
- Existing code would require breaking changes
- New approach is significantly cleaner AND user approves

**Anti-Pattern**: Creating new functions while similar ones exist

### 2.3 When to Refactor vs Patch

**Patch** (default for bug fixes):
- Minimal change to fix issue
- No surrounding code cleanup
- Keep PR small and focused

**Refactor** (only when requested):
- User explicitly asks for cleanup
- Bug fix is impossible without refactoring
- Technical debt is blocking feature

---

## 3. Communication Rules

### 3.1 Language

- **User Interaction**: Korean (한국어)
- **Code Comments**: English
- **Documentation**: English (for LLM context efficiency)
- **Commit Messages**: English with Korean description if needed

### 3.2 Response Style

**DO**:
- Be concise, no unnecessary explanation
- State what was changed, not how it works
- Report test results critically (not optimistically)
- Admit uncertainty when present

**DON'T**:
- Add explanatory padding
- Repeat what user already knows
- Over-explain code changes
- Use emojis unless user does

### 3.3 Critical Analysis Mindset

**ALWAYS**:
- Analyze results critically, not positively
- Question if test truly passed
- Look for edge cases
- Report what's NOT working, not just what IS

**Example**:
```
❌ "Implementation complete. Everything works."
✅ "기능 구현 완료. 단, 에러 케이스 테스트 필요: 빈 입력, 타임아웃."
```

---

## 4. Code Style Guidelines

### 4.1 Backend (FastAPI)

**Required**:
- `async def` for all endpoint handlers
- Type hints for all parameters and returns
- 30s timeout for external HTTP calls
- HTTPException for all error responses

**Pattern**:
```python
async def endpoint(param: str) -> Dict[str, Any]:
    try:
        async with httpx.AsyncClient(timeout=30.0) as client:
            response = await client.get(url)
            response.raise_for_status()
            return response.json()
    except httpx.TimeoutException:
        raise HTTPException(status_code=504, detail="Timeout")
    except httpx.HTTPStatusError as e:
        raise HTTPException(status_code=e.response.status_code)
```

### 4.2 Frontend (Svelte + Tailwind)

**Required**:
- Dark/light mode support for all components
- Responsive design
- API calls via `/api/*` proxy (never direct localhost)

**Admin UI Pattern**:
```svelte
<div class="bg-white/60 dark:bg-gray-800/60 backdrop-blur-sm rounded-2xl 
            border border-white/20 dark:border-gray-700/20 shadow-sm p-6">
  <!-- Glassmorphism card -->
</div>
```

### 4.3 Error Handling

**Backend**: Always catch and wrap errors
```python
try:
    # operation
except SpecificError as e:
    raise HTTPException(status_code=XXX, detail=str(e))
except Exception as e:
    raise HTTPException(status_code=500, detail=f"Unexpected: {e}")
```

**Frontend**: Check response.ok
```typescript
const response = await fetch('/api/...');
if (!response.ok) {
    const error = await response.json();
    throw new Error(error.detail || 'Request failed');
}
```

---

## 5. Workflow Rules

### 5.1 Before Service Restart/Rebuild

**MUST run first**:
```bash
./scripts/health-check.sh
```

**Check state**:
```bash
cat .cursor/state/services.json | jq '.services'
```

### 5.2 Build/Restart Procedure

```bash
# 1. Save state (creates rollback point)
./scripts/pre-build.sh <service>

# 2. Rebuild
docker compose build --no-cache <service>

# 3. Start
docker compose up -d <service>

# 4. Verify
./scripts/health-check.sh
```

### 5.3 After Code Changes

1. If backend code changed → Rebuild container
2. If frontend code changed → Hot reload or rebuild
3. Always verify with actual test
4. Check logs for errors: `docker compose logs <service> --tail=50`

---

## 6. Prohibited Actions

### 6.1 Ignoring Existing Patterns
```
❌ Creating new styling approach when similar component exists
✅ Reusing established patterns from codebase
```

### 6.2 Skipping Tests
```
❌ Marking "complete" without running tests
✅ Actually executing and verifying functionality
```

### 6.3 Missing Error Handling
```
❌ External calls without try/except
✅ Timeout handling, HTTP error handling, exception wrapping
```

### 6.4 Direct API Calls in Frontend
```
❌ fetch('http://localhost:8000/...')
✅ fetch('/api/...')  // Via Vite proxy
```

### 6.5 Skipping State Check Before Restart
```
❌ Immediately running docker restart
✅ Running ./scripts/health-check.sh first
```

### 6.6 Hardcoding
```
❌ Regex patterns with hardcoded values
❌ Hardcoded prompts in LLM calls
✅ Configuration-driven, parameterized approaches
```

### 6.7 Infinite New Code Creation
```
❌ Creating new functions when similar exists
✅ Maximally reusing existing code
```

---

## 7. Reference Documents

### 7.1 Priority Order

1. **Domain Rules** (`.cursor/rules/*.mdc`):
   - `backend-api.mdc` — FastAPI patterns
   - `ui-development.mdc` — Svelte/Tailwind
   - `admin-screens.mdc` — Admin UI patterns
   - `monitoring-development.mdc` — ClickHouse, OTEL
   - `datacloud-development.mdc` — Database connector
   - `mcp-gateway.mdc` — MCP, Kong

2. **Project Reference**:
   - `AGENTS.md` — Architecture, services, troubleshooting
   - `CLAUDE.md` — Quick reference

3. **On-Demand**:
   - `webui/.skills/ui-summary.json` — Route/pattern lookup

### 7.2 When to Consult

- **Before UI work**: Check `ui-summary.json` for routes
- **Before API work**: Check existing services in `backend/app/services/`
- **For ClickHouse**: MUST read `monitoring-development.mdc`
- **For Data Cloud**: MUST read `datacloud-development.mdc`

---

## 8. Learning System

### 8.1 Record Learnings

After significant work, record in `.cursor/learnings/`:
- `api-patterns.md` — Backend patterns discovered
- `ui-patterns.md` — Frontend patterns discovered  
- `bug-fixes.md` — Issues and solutions
- `preferences.md` — User preferences learned

### 8.2 Recording Format

```markdown
## YYYY-MM-DD: Title

**Request**: What was asked
**Applied**: What was implemented
**Feedback**: ✅ Approved / ❌ Rejected
**Reuse**: How to apply in future
```

---

## 9. User Preferences (Learned)

### 9.1 Communication
- Communicate in Korean
- Be concise, no unnecessary explanation
- Report only what changed

### 9.2 Development
- Critical analysis over positive interpretation
- Test before marking complete
- Ask before modifying working code
- Think deeply before suggesting changes

### 9.3 Prohibited
- Hardcoding values
- Creating infinite new functions
- Skipping tests
- Over-engineering simple tasks

---

**Last Updated**: 2025-11-28
**Version**: 5.0 (AI Behavioral Guidelines)
