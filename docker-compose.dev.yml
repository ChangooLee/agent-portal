# Development Override Docker Compose
# Extends docker-compose.yml with development-specific settings
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.dev.yml up -d
#   docker compose -f docker-compose.yml -f docker-compose.dev.yml build backend
#
# Shortcut (create alias in .bashrc/.zshrc):
#   alias dcdev='docker compose -f docker-compose.yml -f docker-compose.dev.yml'

services:
  # Backend - Development overrides
  backend:
    environment:
      - DEBUG=true
      - LOG_LEVEL=debug
      # ClickHouse connection (use Docker internal network to avoid Cursor port conflicts)
      - CLICKHOUSE_HOST=monitoring-clickhouse
      - CLICKHOUSE_HTTP_PORT=8123  # Use internal port (external 8125 may conflict with Cursor)
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=password
      - CLICKHOUSE_DATABASE=otel_2
      # LiteLLM connection (use Docker internal network to avoid Cursor port conflicts)
      - LITELLM_HOST=http://litellm:4000
      - LITELLM_MASTER_KEY=${LITELLM_MASTER_KEY}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    # Override server-only volume mount (remove /home3 path)
    volumes: []

  # WebUI - Development overrides  
  # Database: Uses SQLite (default) - data in ./webui/backend/data/webui.db
  webui:
    build:
      context: ./webui
      dockerfile: Dockerfile.dev
    ports:
      - "3009:3001"    # Vite dev server (3005-3008 occupied by Cursor/Docker)
      - "3000:8080"    # Backend API
    environment:
      - NODE_ENV=development
      - DOCKER_ENV=true
      - VITE_HMR_PORT=3009  # External port for HMR WebSocket
      # LiteLLM connection (use Docker internal network to avoid Cursor port conflicts)
      - OPENAI_API_BASE_URLS=http://litellm:4000/v1
      - OPENAI_API_KEYS=${LITELLM_MASTER_KEY}
      - ENABLE_OPENAI_API=true
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./webui:/app
      - webui_node_modules:/app/node_modules
      - ./webui/backend/data:/app/backend/data  # Override webui_data with local path for dev
    command: ["bash", "-c", "chmod +x /app/dev-start.sh && /app/dev-start.sh"]

  # LiteLLM - Development overrides
  litellm:
    environment:
      - LITELLM_LOG=DEBUG

  # LiteLLM PostgreSQL - Development overrides
  litellm-postgres:
    ports:
      - "5433:5432"  # 개발 환경용 외부 접근

volumes:
  webui_node_modules:
