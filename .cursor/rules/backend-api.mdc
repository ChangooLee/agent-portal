---
alwaysApply: false
---
# Backend API Development Rules

Rules for developing FastAPI BFF and WebUI Backend APIs.

## Architecture

```
agent-portal/
├── backend/                    # FastAPI BFF (port 8000)
│   ├── app/
│   │   ├── routes/            # API routers
│   │   ├── services/          # Business logic (Singleton)
│   │   ├── middleware/        # RBAC, auth
│   │   └── main.py            # App entry
│   └── requirements.txt
│
└── webui/backend/              # Open-WebUI backend (port 8080)
    └── open_webui/
        ├── routers/           # API routers
        ├── models/            # SQLAlchemy models
        └── main.py            # App entry
```

## Service Layer Pattern (Singleton)

```python
# backend/app/services/example_service.py
from typing import Dict, Any
import httpx
from fastapi import HTTPException

class ExampleService:
    """Service for external API calls."""
    
    def __init__(self):
        self.base_url = "http://service:8080"
    
    async def get_data(self, id: str) -> Dict[str, Any]:
        """Fetch data by ID.
        
        Args:
            id: Resource identifier
            
        Returns:
            Data dictionary
            
        Raises:
            HTTPException: On API failure
        """
        try:
            async with httpx.AsyncClient(timeout=30.0) as client:
                response = await client.get(f"{self.base_url}/data/{id}")
                response.raise_for_status()
                return response.json()
        except httpx.TimeoutException:
            raise HTTPException(status_code=504, detail="Timeout")
        except httpx.HTTPStatusError as e:
            raise HTTPException(status_code=e.response.status_code, detail=str(e))

# Singleton instance
example_service = ExampleService()
```

## Router Pattern

```python
# backend/app/routes/example.py
from fastapi import APIRouter, HTTPException, Query
from pydantic import BaseModel
from typing import List, Optional
from datetime import datetime

router = APIRouter(prefix="/example", tags=["example"])

class ExampleRequest(BaseModel):
    name: str
    value: int

class ExampleResponse(BaseModel):
    id: str
    name: str
    created_at: datetime

@router.get("/", response_model=List[ExampleResponse])
async def list_examples(
    page: int = Query(1, ge=1),
    size: int = Query(20, ge=1, le=100)
):
    """List all examples with pagination."""
    return await example_service.list_all(page=page, size=size)

@router.post("/", response_model=ExampleResponse)
async def create_example(request: ExampleRequest):
    """Create new example."""
    try:
        return await example_service.create(request.dict())
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))
```

## Error Handling (REQUIRED)

### External API Calls

```python
try:
    async with httpx.AsyncClient(timeout=30.0) as client:
        response = await client.get(url)
        response.raise_for_status()
        return response.json()
except httpx.TimeoutException:
    raise HTTPException(status_code=504, detail="External API timeout")
except httpx.HTTPStatusError as e:
    raise HTTPException(status_code=e.response.status_code, detail=str(e))
except Exception as e:
    raise HTTPException(status_code=500, detail=f"Unexpected error: {str(e)}")
```

### Database Operations

```python
try:
    result = await db.execute(query, params)
    return result
except Exception as e:
    logger.error(f"Database error: {e}")
    raise HTTPException(status_code=500, detail="Database operation failed")
```

## Optional Imports (Graceful Degradation)

```python
try:
    from langfuse import Langfuse
    LANGFUSE_AVAILABLE = True
except ImportError:
    LANGFUSE_AVAILABLE = False
    Langfuse = None

class LangfuseService:
    def __init__(self):
        self.client = Langfuse() if LANGFUSE_AVAILABLE else None
    
    def create_trace(self, name: str):
        if self.client:
            return self.client.trace(name=name)
        return None  # Graceful degradation
```

## Database Queries (CRITICAL)

### Always Check Schema First

```bash
# MariaDB
docker-compose exec mariadb mariadb -uroot -prootpass agent_portal \
  -e "DESCRIBE table_name;"

# ClickHouse
docker-compose exec monitoring-clickhouse clickhouse-client \
  --query "DESCRIBE otel_2.otel_traces;"
```

### ClickHouse Map Access

```python
# ❌ WRONG: project_id is not a direct column
query = "SELECT * FROM otel_traces WHERE project_id = '...'"

# ✅ CORRECT: Access from ResourceAttributes map
query = """
SELECT 
    TraceId as trace_id,
    ResourceAttributes['project_id'] as project_id
FROM otel_2.otel_traces
WHERE ResourceAttributes['project_id'] = '{project_id}'
"""
```

### Duration Conversion

```python
# ClickHouse stores Duration in nanoseconds
# Convert to milliseconds: Duration / 1000000
query = "SELECT Duration / 1000000 as duration_ms FROM otel_traces"
```

## Registering Routes

```python
# backend/app/main.py
from fastapi import FastAPI
from app.routes import example, monitoring, datacloud

app = FastAPI(title="Agent Portal API")

# Register routers
app.include_router(example.router)
app.include_router(monitoring.router, prefix="/api/monitoring")
app.include_router(datacloud.router, prefix="/datacloud")
```

## WebUI Backend PYTHONPATH (CRITICAL)

When running webui/backend locally:

```bash
# ❌ WRONG: ModuleNotFoundError
uvicorn open_webui.main:app --reload

# ✅ CORRECT: Set PYTHONPATH
cd webui/backend
PYTHONPATH=. uvicorn open_webui.main:app --host 0.0.0.0 --port 8080 --reload
```

## Checklist

### Before Coding
- [ ] Check existing service patterns
- [ ] Review similar endpoints
- [ ] Plan error handling

### During Coding
- [ ] Use `async def`
- [ ] Add type hints
- [ ] Set timeout (30s default)
- [ ] Handle all exceptions

### After Coding
- [ ] Test with curl
- [ ] Check `/docs` for OpenAPI
- [ ] Check container logs

## Prohibited

- ❌ Sync methods for I/O operations
- ❌ Missing type hints
- ❌ External calls without timeout
- ❌ Missing error handling
- ❌ Hardcoded credentials
- ❌ Direct SQL without parameter binding

---

**Last Updated**: 2025-11-28
