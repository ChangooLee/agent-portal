#!/bin/bash
# Pre-commit hook: ë¬¸ì„œ ì¼ê´€ì„± ì²´í¬ ë° ë¦°íŠ¸

echo "ğŸ” Pre-commit checks..."

# 1. UI íŒŒì¼ ë³€ê²½ ì‹œ Skills ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸ í™•ì¸
UI_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^webui/src/(routes|lib/components)/.*\.(svelte|ts)$')

if [ -n "$UI_FILES" ]; then
    echo "  âš ï¸  UI files changed. Consider running: ./scripts/update-ui-skills.sh"
    echo "     Changed files:"
    echo "$UI_FILES" | sed 's/^/     - /'
fi

# 2. .mdc íŒŒì¼ lastUpdated ìë™ ì—…ë°ì´íŠ¸
MDC_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.mdc$')

if [ -n "$MDC_FILES" ]; then
    echo "  ğŸ“ Updating lastUpdated in .mdc files..."
    
    TODAY=$(date +%Y-%m-%d)
    
    for file in $MDC_FILES; do
        if [ -f "$file" ]; then
            # lastUpdated í•„ë“œ ì—…ë°ì´íŠ¸
            if grep -q "^lastUpdated:" "$file"; then
                # macOSì™€ Linux í˜¸í™˜ sed ì‚¬ìš©
                if [[ "$OSTYPE" == "darwin"* ]]; then
                    # macOS
                    sed -i '' "s/^lastUpdated: .*/lastUpdated: $TODAY/" "$file"
                else
                    # Linux
                    sed -i "s/^lastUpdated: .*/lastUpdated: $TODAY/" "$file"
                fi
                echo "     âœ… Updated $file (lastUpdated: $TODAY)"
                # ë³€ê²½ì‚¬í•­ stageì— ì¶”ê°€
                git add "$file"
            else
                echo "     âš ï¸  $file: lastUpdated field not found"
            fi
        fi
    done
fi

# 3. í•µì‹¬ ë¬¸ì„œ ë™ê¸°í™” ì²´í¬
CORE_DOCS=("CLAUDE.md" "AGENTS.md" "README.md" "DEVELOP.md")
DOCS_CHANGED=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^(CLAUDE|AGENTS|README|DEVELOP)\.md$')

if [ -n "$DOCS_CHANGED" ]; then
    echo "  ğŸ“ Core documents changed:"
    echo "$DOCS_CHANGED" | sed 's/^/     - /'
    echo "     Ensure all core documents are synchronized."
fi

# 4. Python íŒŒì¼ ë¦°íŠ¸ (backend ë³€ê²½ ì‹œ)
PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$')

if [ -n "$PYTHON_FILES" ]; then
    echo "  ğŸ Linting Python files..."
    # flake8ê°€ ì„¤ì¹˜ë˜ì–´ ìˆìœ¼ë©´ ì‹¤í–‰
    if command -v flake8 &> /dev/null; then
        echo "$PYTHON_FILES" | xargs flake8 --max-line-length=100 || true
    fi
fi

# 5. Svelte íŒŒì¼ ì²´í¬ (webui ë³€ê²½ ì‹œ)
SVELTE_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.svelte$')

if [ -n "$SVELTE_FILES" ]; then
    echo "  ğŸ¨ Checking Svelte files..."
    # svelte-checkê°€ ì„¤ì¹˜ë˜ì–´ ìˆìœ¼ë©´ ì‹¤í–‰
    if command -v svelte-check &> /dev/null; then
        cd webui && svelte-check --threshold warning --fail-on-warnings || true
        cd ..
    fi
fi

# 6. ì„ì‹œ ë¬¸ì„œ ì²´í¬
TEMP_PATTERNS="IMPLEMENTATION_.*\.md|TEMP_.*\.md|TODO_.*\.md|DRAFT_.*\.md|WIP_.*\.md|DECISION_.*\.md|ANALYSIS_.*\.md|DEBUG_.*\.md|.*_TEMP\.md|.*_WIP\.md|.*_DRAFT\.md"
TEMP_DOCS=$(find . -maxdepth 3 -type f \( -name "IMPLEMENTATION_*.md" -o -name "TEMP_*.md" -o -name "TODO_*.md" -o -name "DRAFT_*.md" -o -name "WIP_*.md" -o -name "DECISION_*.md" -o -name "ANALYSIS_*.md" -o -name "DEBUG_*.md" -o -name "*_TEMP.md" -o -name "*_WIP.md" -o -name "*_DRAFT.md" \) 2>/dev/null | grep -v -E '(node_modules|\.git|dist|build|\.next|langflow|flowise|autogen|perplexica|litellm|external)')

if [ -n "$TEMP_DOCS" ]; then
    TEMP_COUNT=$(echo "$TEMP_DOCS" | wc -l | tr -d ' ')
    echo "  ğŸ§¹ ì„ì‹œ ë¬¸ì„œ ë°œê²¬: ${TEMP_COUNT}ê°œ"
    echo "$TEMP_DOCS" | sed 's/^/     - /'
    echo "     ê¶Œì¥: ./scripts/clean-temp-docs.sh ì‹¤í–‰í•˜ì—¬ ì •ë¦¬"
    echo "     ìë™ ì •ë¦¬: ./scripts/clean-temp-docs.sh --auto"
fi

echo "âœ… Pre-commit checks completed"
exit 0

