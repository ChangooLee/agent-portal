#!/bin/bash
# Pre-commit hook: ë¬¸ì„œ ì¼ê´€ì„± ì²´í¬ ë° ë¦°íŠ¸

echo "ðŸ” Pre-commit checks..."

# 1. UI íŒŒì¼ ë³€ê²½ ì‹œ Skills ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸ í™•ì¸
UI_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^webui/src/(routes|lib/components)/.*\.(svelte|ts)$')

if [ -n "$UI_FILES" ]; then
    echo "  âš ï¸  UI files changed. Consider running: ./scripts/update-ui-skills.sh"
    echo "     Changed files:"
    echo "$UI_FILES" | sed 's/^/     - /'
fi

# 2. .mdc íŒŒì¼ lastUpdated ìžë™ ì—…ë°ì´íŠ¸
MDC_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.mdc$')

if [ -n "$MDC_FILES" ]; then
    echo "  ðŸ“ Updating lastUpdated in .mdc files..."
    
    TODAY=$(date +%Y-%m-%d)
    
    for file in $MDC_FILES; do
        if [ -f "$file" ]; then
            # lastUpdated í•„ë“œ ì—…ë°ì´íŠ¸
            if grep -q "^lastUpdated:" "$file"; then
                # macOSì™€ Linux í˜¸í™˜ sed ì‚¬ìš©
                if [[ "$OSTYPE" == "darwin"* ]]; then
                    # macOS
                    sed -i '' "s/^lastUpdated: .*/lastUpdated: $TODAY/" "$file"
                else
                    # Linux
                    sed -i "s/^lastUpdated: .*/lastUpdated: $TODAY/" "$file"
                fi
                echo "     âœ… Updated $file (lastUpdated: $TODAY)"
                # ë³€ê²½ì‚¬í•­ stageì— ì¶”ê°€
                git add "$file"
            else
                echo "     âš ï¸  $file: lastUpdated field not found"
            fi
        fi
    done
fi

# 3. í•µì‹¬ ë¬¸ì„œ ë™ê¸°í™” ì²´í¬
CORE_DOCS=("CLAUDE.md" "AGENTS.md" "README.md" "DEVELOP.md")
DOCS_CHANGED=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^(CLAUDE|AGENTS|README|DEVELOP)\.md$')

if [ -n "$DOCS_CHANGED" ]; then
    echo "  ðŸ“ Core documents changed:"
    echo "$DOCS_CHANGED" | sed 's/^/     - /'
    echo "     Ensure all core documents are synchronized."
fi

# 4. Python íŒŒì¼ ë¦°íŠ¸ (backend ë³€ê²½ ì‹œ)
PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$')

if [ -n "$PYTHON_FILES" ]; then
    echo "  ðŸ Linting Python files..."
    # flake8ê°€ ì„¤ì¹˜ë˜ì–´ ìžˆìœ¼ë©´ ì‹¤í–‰
    if command -v flake8 &> /dev/null; then
        echo "$PYTHON_FILES" | xargs flake8 --max-line-length=100 || true
    fi
fi

# 5. Svelte íŒŒì¼ ì²´í¬ (webui ë³€ê²½ ì‹œ)
SVELTE_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.svelte$')

if [ -n "$SVELTE_FILES" ]; then
    echo "  ðŸŽ¨ Checking Svelte files..."
    # svelte-checkê°€ ì„¤ì¹˜ë˜ì–´ ìžˆìœ¼ë©´ ì‹¤í–‰
    if command -v svelte-check &> /dev/null; then
        cd webui && svelte-check --threshold warning --fail-on-warnings || true
        cd ..
    fi
fi

echo "âœ… Pre-commit checks completed"
exit 0

