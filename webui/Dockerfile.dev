# syntax=docker/dockerfile:1
# 개발 모드용 Dockerfile - Hot reload 지원
# 프론트엔드와 백엔드를 함께 실행

FROM python:3.11-slim-bookworm

# Node.js 설치
RUN apt-get update && \
    apt-get install -y --no-install-recommends curl git build-essential gcc python3-dev && \
    curl -fsSL https://deb.nodesource.com/setup_22.x | bash - && \
    apt-get install -y nodejs && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

# 의존성 파일만 먼저 복사 (캐시 최적화)
COPY package.json package-lock.json ./
COPY backend/requirements.txt ./backend/requirements.txt

# Node.js 의존성 설치 (개발 모드에서는 npm install 사용)
RUN npm install

# Python 의존성 설치
RUN pip3 install --no-cache-dir uv && \
    uv pip install --system -r backend/requirements.txt --no-cache-dir

# PYTHONPATH에 backend 디렉토리 추가하여 open_webui 모듈을 찾을 수 있도록 함
ENV PYTHONPATH=/app/backend:$PYTHONPATH

## RAG Embedding model settings ##
ENV RAG_EMBEDDING_MODEL="sentence-transformers/all-MiniLM-L6-v2" \
    SENTENCE_TRANSFORMERS_HOME="/app/backend/data/cache/embedding/models"

# dev-start.sh는 볼륨 마운트로 제공되므로 COPY하지 않음
# 볼륨 마운트에서 실행 권한 부여는 docker-compose에서 처리

# 소스 코드는 볼륨 마운트로 제공되므로 COPY하지 않음
# 개발 서버는 docker-compose에서 command로 실행

# Vite dev server 포트 및 백엔드 포트
EXPOSE 5173 8080

# 개발 모드 실행 (프론트엔드 + 백엔드 함께)
CMD ["./dev-start.sh"]
